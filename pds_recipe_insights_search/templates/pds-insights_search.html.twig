{{ attach_library('pds_recipe_insights_search/insights_search') }}

{# Inputs (all optional)
  - heading: string
  - search_placeholder: string
  - total: int
  - themes: [{ id: 'global', label: 'Global', active: true }, ...]
  - items: [{
      theme_id, theme_label, title, read_time, summary, author, url, link_text
    }, ...]
  - pages: [1,2,3,...]
  - entries: 8|16|24
  - icons_path: '/themes/custom/your_theme/icons'
#}

{% set attributes = attributes|default(create_attribute()) %}
{% if component_id|default('') %}
  {% set attributes = attributes.setAttribute('data-pds-insights-search-id', component_id) %}
{% endif %}
{% set _heading = heading|default(title|default('Latest insights')) %}
{% set _icons = icons_path %}
{% set _featured_items = featured_items|default([]) %}
{% set _display_mode = display_mode|default('featured') %}
{% if _display_mode == 'featured' and _featured_items is empty and items is defined and items|length > 0 %}
  {% set _featured_items = items %}
{% endif %}

{% set _initial_items = initial_items|default([]) %}
{% if _initial_items is empty and items is defined and items|length > 0 %}
  {% set _initial_items = items %}
{% endif %}

{% set _items = _initial_items %}
{% set _total = total|default(_initial_items|length) %}
{% set _pages = pages|default([1]) %}
{% if _pages is not iterable %}
  {% set _pages = [1] %}
{% endif %}
{% set _featured_json = _featured_items is empty ? '[]' : _featured_items|json_encode %}
{% set _featured_attr = _featured_json ? _featured_json|e('html_attr') : '[]' %}
{% set _entries_default = entries|default(6) %}
{# //1.- Craft a stable identifier so the floating filters panel links to its trigger via aria-controls. #}
{% set filter_menu_id = component_id ? component_id ~ '-filters-menu' : 'pds-insights-filters-menu-' ~ random() %}

<section class="principal-insights" {{ attributes|default('') }}>
  <div class="container">
    <div class="principal-row-container">

      <div class="head-row">
        <h2>{{ _heading }}</h2>

        <div class="insights-filters">
          <div class="search-bar">
            <input
              type="text"
              class="search-input"
              placeholder="{{ search_placeholder|default('Search') }}"
              aria-label="{{ 'Search insights'|t }}"
            />
            <button class="search-button" aria-label="{{ 'Search'|t }}">
              <img src="{{ _icons }}/search.svg" alt="" aria-hidden="true" />
            </button>
          </div>

          <div class="filter-actions">
            <button
              class="filter-button"
              type="button"
              aria-haspopup="true"
              aria-expanded="false"
              aria-controls="{{ filter_menu_id }}"
            >
              {{ 'Filter by'|t }}
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 5L6 8L9 5" stroke="#0071B3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>

            {# //2.- Render the floating menu as a hidden panel that mirrors every available theme as a checkbox control. #}
            <div class="insights-filters__backdrop" hidden data-filter-backdrop></div>
            <div
              id="{{ filter_menu_id }}"
              class="insights-filters__menu"
              hidden
              role="dialog"
              aria-modal="true"
              data-filter-menu
            >
              <fieldset class="insights-filters__fieldset">
                <legend class="visually-hidden">{{ 'Filter insights by theme'|t }}</legend>
                <div class="insights-filters__list">
                  {% for theme in themes|default([
                    {'id':'global','tid':'1','label':'Global','active':true},
                    {'id':'latam','tid':'2','label':'LATAM','active':false}
                  ]) %}
                    <label class="insights-filters__option">
                      <input
                        type="checkbox"
                        class="insights-filters__checkbox"
                        value="{{ theme.tid|default(theme.id)|e }}"
                        data-theme-checkbox
                        data-theme-id="{{ theme.id|lower|e }}"
                        {% if theme.active %}checked{% endif %}
                      />
                      <span>{{ theme.label }}</span>
                    </label>
                  {% endfor %}
                </div>
              </fieldset>
              <div class="insights-filters__actions">
                <button type="button" class="insights-filters__action insights-filters__action--apply" data-filter-apply>{{ 'Apply'|t }}</button>
                <button type="button" class="insights-filters__action insights-filters__action--clear" data-filter-clear>{{ 'Clear'|t }}</button>
              </div>
            </div>
          </div>

          <button class="reset-button" aria-label="{{ 'Reset all filters'|t }}">{{ 'Reset All'|t }}</button>
        </div>

        <div class="total-results" data-total>
          {{ _total }} {{ 'total results'|t }}
        </div>

        <div class="explore-themes">
          <h3>{{ 'Explore themes'|t }}</h3>
          <div class="theme-tags">
            {% for theme in themes|default([
              {'id':'global','label':'Global','active':true},
              {'id':'latam','label':'LATAM','active':false}
            ]) %}
              <button
                class="theme-tag {{ theme.active ? 'active' }}"
                data-theme="{{ theme.id|e }}"
              >{{ theme.label }}</button>
            {% endfor %}
          </div>
        </div>
      </div>

      <div
        class="insights-cards"
        data-empty-message="{{ 'No results found.'|t }}"
        data-icons-path="{{ _icons }}"
        data-featured-items="{{ _featured_attr }}"
      >
        {% for item in _items %}
          <div class="insight-card" data-theme="{{ item.theme_id|e }}">
            {% if item.theme_label %}
              <span class="insight-badge {{ item.theme_id|e }}">{{ item.theme_label }}</span>
            {% endif %}

            <h3 class="insight-card-title">{{ item.title }}</h3>

            <div class="insight-meta">
              {% if item.read_time %}
                <span class="insight-time">ðŸ•’ {{ item.read_time }}</span>
              {% endif %}
            </div>

            {% if item.summary %}
              <p class="insight-summary">{{ item.summary }}</p>
            {% endif %}

            {% if item.author %}
              <div class="insight-author"><span>{{ 'By'|t }}</span> {{ item.author }}</div>
            {% endif %}

            <div class="button-area">
              <a href="{{ item.url|default('#') }}" class="principal-link principal-link--subtle">
                {{ item.link_text|default('Get our perspective'|t) }}
              </a>
              <div class="img-area">
                <img src="{{ _icons }}/arrow-right.svg" alt="" aria-hidden="true" />
              </div>
            </div>
          </div>
        {% else %}
          <p>{{ 'No results found.'|t }}</p>
        {% endfor %}
      </div>

      <div class="insights-pagination">
        <div class="pagination-entries">
          <label for="entries-select">{{ 'Show'|t }}</label>
          <select class="entries-select" id="entries-select">
            {% for n in [6,8,16,24] %}
              <option value="{{ n }}" {{ n == _entries_default ? 'selected' }}>{{ n }}</option>
            {% endfor %}
          </select>
          <span>{{ 'entries'|t }}</span>
        </div>

        <div class="pagination-controls">
          <button class="page-first" aria-label="{{ 'First page'|t }}">
            <img src="{{ _icons }}/first-page.svg" alt="" aria-hidden="true" />
          </button>
          <button class="page-prev" aria-label="{{ 'Previous page'|t }}" disabled>
            <img src="{{ _icons }}/left-filter.png" alt="" aria-hidden="true" />
          </button>

          <div class="page-numbers">
            {% for p in _pages %}
              <button class="page-number {{ loop.first ? 'active' }}">{{ p }}</button>
            {% endfor %}
          </div>

          <button class="page-next" aria-label="{{ 'Next page'|t }}">
            <img src="{{ _icons }}/next-page.svg" alt="" aria-hidden="true" />
          </button>
          <button class="page-last" aria-label="{{ 'Last page'|t }}">
            <img src="{{ _icons }}/last-page.svg" alt="" aria-hidden="true" />
          </button>
        </div>
      </div>

    </div>
  </div>
</section>
