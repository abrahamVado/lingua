<?php

declare(strict_types=1);

use Drupal\Component\Utility\NestedArray;
use Drupal\Component\Utility\UrlHelper;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Form\SubformStateInterface;
use Drupal\file\Entity\File;
use Drupal\file\FileUsage\FileUsageInterface;

/**
 * Implements hook_theme().
 */
function pds_recipe_slider_banner_theme($existing, $type, $theme, $path) {
  return [
    'pds_slider_banner' => [
      'template' => 'pds-slider_banner',
      'path' => $path . '/templates',
      'variables' => [
        'title' => '',
        'section_id' => 'principal-slider_banner',
        'slides' => [],
      ],
    ],
  ];
}

/**
 * AJAX callback to return just the slider_banner_ui container.
 */
function pds_recipe_slider_banner_ajax_events(array &$form, FormStateInterface $form_state) {
  if (isset($form['settings']['slider_banner_ui'])) {
    return $form['settings']['slider_banner_ui'];
  }
  if (isset($form['slider_banner_ui'])) {
    return $form['slider_banner_ui'];
  }
  return $form;
}

/**
 * Persist the selected admin tab between AJAX rebuilds.
 */
function pds_recipe_slider_banner_set_active_tab(FormStateInterface $form_state, string $tab): void {
  //1.- Store the choice on the current form state instance.
  $form_state->set('pds_recipe_slider_banner_active_tab', $tab);

  //2.- Mirror the setting on the parent form state when nested in Layout Builder.
  $parent_state = pds_recipe_slider_banner_parent_state($form_state);
  if ($parent_state) {
    $parent_state->set('pds_recipe_slider_banner_active_tab', $tab);
  }

  //3.- Synchronize the hidden form value so the next rebuild honors the tab choice.
  $form_state->setValue(['slider_banner_ui_active_tab'], $tab);
  $user_input = $form_state->getUserInput();
  if (!is_array($user_input)) {
    $user_input = [];
  }
  $user_input['slider_banner_ui_active_tab'] = $tab;
  $form_state->setUserInput($user_input);

  if ($parent_state) {
    $parent_state->setValue(['slider_banner_ui_active_tab'], $tab);
    $parent_input = $parent_state->getUserInput();
    if (!is_array($parent_input)) {
      $parent_input = [];
    }
    $parent_input['slider_banner_ui_active_tab'] = $tab;
    $parent_state->setUserInput($parent_input);
  }
}

/**
 * Validation for adding a new slide.
 */
function pds_recipe_slider_banner_add_slide_validate(array &$form, FormStateInterface $form_state): void {
  $base_key = pds_recipe_slider_banner_base_key($form, $form_state, ['slider_banner_ui', 'panes', 'add_slide']);
  $parent_state = pds_recipe_slider_banner_parent_state($form_state);

  //1.- Collect author input from the correct form tree branch.
  $desktop_src = trim((string) $form_state->getValue(array_merge($base_key, ['slide_desktop_src'])));
  $desktop_upload = $form_state->getValue(array_merge($base_key, ['slide_desktop_upload']));
  $desktop_upload_info = pds_recipe_slider_banner_extract_uploaded_image($desktop_upload);
  $mobile_src = trim((string) $form_state->getValue(array_merge($base_key, ['slide_mobile_src'])));
  $mobile_upload = $form_state->getValue(array_merge($base_key, ['slide_mobile_upload']));
  $mobile_upload_info = pds_recipe_slider_banner_extract_uploaded_image($mobile_upload);
  $alt = trim((string) $form_state->getValue(array_merge($base_key, ['slide_alt'])));
  $title_html = trim((string) $form_state->getValue(array_merge($base_key, ['slide_title_html'])));
  $intro = trim((string) $form_state->getValue(array_merge($base_key, ['slide_intro'])));
  $cta_label = trim((string) $form_state->getValue(array_merge($base_key, ['slide_cta_label'])));
  $cta_url = trim((string) $form_state->getValue(array_merge($base_key, ['slide_cta_url'])));

  //2.- Merge upload-derived URLs when available.
  if ($desktop_upload_info['error'] !== NULL) {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_desktop_upload'])), $desktop_upload_info['error']);
  }
  elseif ($desktop_upload_info['url'] !== NULL) {
    $desktop_src = $desktop_upload_info['url'];
  }

  if ($mobile_upload_info['error'] !== NULL) {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_mobile_upload'])), $mobile_upload_info['error']);
  }
  elseif ($mobile_upload_info['url'] !== NULL) {
    $mobile_src = $mobile_upload_info['url'];
  }

  //3.- Validate mandatory slide attributes.
  if ($desktop_src === '') {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_desktop_src'])), t('Desktop image URL is required.'));
  }
  if ($mobile_src === '') {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_mobile_src'])), t('Mobile image URL is required.'));
  }
  if ($alt === '') {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_alt'])), t('Alternative text is required.'));
  }
  if ($title_html === '') {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_title_html'])), t('Title is required.'));
  }
  if ($cta_label === '') {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_cta_label'])), t('CTA label is required.'));
  }
  if ($cta_url === '') {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_cta_url'])), t('CTA URL is required.'));
  }

  //4.- Enforce safe URL formats.
  if ($desktop_src !== '' && !pds_recipe_slider_banner_is_allowed_url($desktop_src)) {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_desktop_src'])), t('Desktop image URL must be absolute or start with / or a stream wrapper.'));
  }
  if ($mobile_src !== '' && !pds_recipe_slider_banner_is_allowed_url($mobile_src)) {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_mobile_src'])), t('Mobile image URL must be absolute or start with / or a stream wrapper.'));
  }
  if ($cta_url !== '' && !pds_recipe_slider_banner_is_allowed_url($cta_url)) {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_cta_url'])), t('CTA URL must be absolute or start with /.'));
  }

  if ($form_state->hasAnyErrors()) {
    $form_state->set('pds_recipe_slider_banner_add_slide_new_slide', NULL);
    if ($parent_state) {
      $parent_state->set('pds_recipe_slider_banner_add_slide_new_slide', NULL);
    }
    return;
  }

  //5.- Store a clean snapshot for the submit handler.
  $payload = [
    'desktop_src' => $desktop_src,
    'mobile_src' => $mobile_src,
    'alt' => $alt,
    'title_html' => $title_html,
    'intro' => $intro,
    'cta_label' => $cta_label,
    'cta_url' => $cta_url,
  ];

  if ($desktop_upload_info['fid'] !== NULL) {
    $payload['desktop_file_fid'] = $desktop_upload_info['fid'];
  }
  if ($mobile_upload_info['fid'] !== NULL) {
    $payload['mobile_file_fid'] = $mobile_upload_info['fid'];
  }

  $form_state->set('pds_recipe_slider_banner_add_slide_new_slide', $payload);
  if ($parent_state) {
    $parent_state->set('pds_recipe_slider_banner_add_slide_new_slide', $payload);
  }
}

/**
 * Submit handler that appends the validated slide to the working list.
 */
function pds_recipe_slider_banner_add_slide_submit(array &$form, FormStateInterface $form_state): void {
  $base_key = pds_recipe_slider_banner_base_key($form, $form_state, ['slider_banner_ui', 'panes', 'add_slide']);
  $parent_state = pds_recipe_slider_banner_parent_state($form_state);

  //1.- Retrieve sanitized information prepared by validation.
  $new_slide = $form_state->get('pds_recipe_slider_banner_add_slide_new_slide');
  if (!is_array($new_slide)) {
    return;
  }

  pds_recipe_slider_banner_finalize_slide_payload($new_slide);

  //2.- Append the new slide to the working list stored in form state.
  $slides = $form_state->get('working_slides');
  if (!is_array($slides)) {
    $slides = [];
  }
  $slides[] = $new_slide;
  $normalized_slides = array_values($slides);

  $form_state->set('working_slides', $normalized_slides);
  if ($parent_state) {
    $parent_state->set('working_slides', $normalized_slides);
  }

  //3.- Reset author-facing inputs for the next addition.
  foreach (['slide_desktop_src', 'slide_mobile_src', 'slide_alt', 'slide_title_html', 'slide_intro', 'slide_cta_label', 'slide_cta_url'] as $key) {
    $form_state->setValue(array_merge($base_key, [$key]), '');
  }
  foreach (['slide_desktop_upload', 'slide_mobile_upload'] as $upload_key) {
    $form_state->setValue(array_merge($base_key, [$upload_key]), []);
  }
  $user_input = $form_state->getUserInput();
  if (!is_array($user_input)) {
    $user_input = [];
  }
  foreach (['slide_desktop_src', 'slide_mobile_src', 'slide_alt', 'slide_title_html', 'slide_intro', 'slide_cta_label', 'slide_cta_url'] as $key) {
    NestedArray::setValue($user_input, array_merge($base_key, [$key]), '');
  }
  foreach (['slide_desktop_upload', 'slide_mobile_upload'] as $upload_key) {
    NestedArray::setValue($user_input, array_merge($base_key, [$upload_key]), []);
  }
  $form_state->setUserInput($user_input);
  if ($parent_state) {
    foreach (['slide_desktop_src', 'slide_mobile_src', 'slide_alt', 'slide_title_html', 'slide_intro', 'slide_cta_label', 'slide_cta_url'] as $key) {
      $parent_state->setValue(array_merge($base_key, [$key]), '');
    }
    foreach (['slide_desktop_upload', 'slide_mobile_upload'] as $upload_key) {
      $parent_state->setValue(array_merge($base_key, [$upload_key]), []);
    }
    $parent_input = $parent_state->getUserInput();
    if (!is_array($parent_input)) {
      $parent_input = [];
    }
    foreach (['slide_desktop_src', 'slide_mobile_src', 'slide_alt', 'slide_title_html', 'slide_intro', 'slide_cta_label', 'slide_cta_url'] as $key) {
      NestedArray::setValue($parent_input, array_merge($base_key, [$key]), '');
    }
    foreach (['slide_desktop_upload', 'slide_mobile_upload'] as $upload_key) {
      NestedArray::setValue($parent_input, array_merge($base_key, [$upload_key]), []);
    }
    $parent_state->setUserInput($parent_input);
  }

  //4.- Reset checkboxes to avoid stale remove selections.
  $table_key = pds_recipe_slider_banner_base_key($form, $form_state, ['slider_banner_ui', 'panes', 'slides_list', 'slides']);
  $checkbox_rows = [];
  foreach ($normalized_slides as $index => $_row) {
    $checkbox_rows[$index] = ['remove' => 0];
  }
  $form_state->setValue($table_key, $checkbox_rows);
  if ($parent_state) {
    $parent_state->setValue($table_key, $checkbox_rows);
  }

  //5.- Clear temp storage and rebuild to refresh UI.
  $form_state->set('pds_recipe_slider_banner_add_slide_new_slide', NULL);
  if ($parent_state) {
    $parent_state->set('pds_recipe_slider_banner_add_slide_new_slide', NULL);
  }
  $form_state->setRebuild(TRUE);
  pds_recipe_slider_banner_set_active_tab($form_state, 'slides');
}

/**
 * Remove selected slides from the working snapshot.
 */
function pds_recipe_slider_banner_remove_slides_submit(array &$form, FormStateInterface $form_state): void {
  $table_key = pds_recipe_slider_banner_base_key($form, $form_state, ['slider_banner_ui', 'panes', 'slides_list', 'slides']);
  $parent_state = pds_recipe_slider_banner_parent_state($form_state);

  $slides = $form_state->get('working_slides');
  if (!is_array($slides)) {
    $slides = [];
  }

  //1.- Gather checkbox values from processed values or raw input.
  $values = $form_state->getValue($table_key);
  if (!is_array($values) && $parent_state) {
    $values = $parent_state->getValue($table_key);
  }
  if (!is_array($values)) {
    $input = $form_state->getUserInput();
    if (is_array($input)) {
      $raw_values = NestedArray::getValue($input, $table_key);
      if (is_array($raw_values)) {
        $values = $raw_values;
      }
    }
  }
  if (!is_array($values) && $parent_state) {
    $parent_input = $parent_state->getUserInput();
    if (is_array($parent_input)) {
      $raw_values = NestedArray::getValue($parent_input, $table_key);
      if (is_array($raw_values)) {
        $values = $raw_values;
      }
    }
  }
  if (!is_array($values)) {
    $values = [];
  }

  //2.- Filter out rows flagged for removal.
  $kept = [];
  foreach ($slides as $index => $slide) {
    $should_remove = !empty($values[$index]['remove']);
    if ($should_remove) {
      continue;
    }
    $kept[] = $slide;
  }

  $form_state->set('working_slides', $kept);
  if ($parent_state) {
    $parent_state->set('working_slides', $kept);
  }

  //3.- Reset checkboxes after deletion.
  $reset_rows = [];
  foreach ($kept as $index => $_row) {
    $reset_rows[$index] = ['remove' => 0];
  }
  $form_state->setValue($table_key, $reset_rows);
  if ($parent_state) {
    $parent_state->setValue($table_key, $reset_rows);
  }

  $form_state->setRebuild(TRUE);
  pds_recipe_slider_banner_set_active_tab($form_state, 'slides');
}

/**
 * Prepare edit mode for a specific slide row.
 */
function pds_recipe_slider_banner_edit_slide_prepare_submit(array &$form, FormStateInterface $form_state): void {
  $trigger = $form_state->getTriggeringElement();
  $index = isset($trigger['#pds_recipe_slider_banner_edit_index']) && is_numeric($trigger['#pds_recipe_slider_banner_edit_index'])
    ? (int) $trigger['#pds_recipe_slider_banner_edit_index']
    : NULL;
  if ($index === NULL) {
    return;
  }

  $parent_state = pds_recipe_slider_banner_parent_state($form_state);
  $form_state->set('pds_recipe_slider_banner_editing_index', $index);
  if ($parent_state) {
    $parent_state->set('pds_recipe_slider_banner_editing_index', $index);
  }

  //1.- Locate the edit pane keys so we can seed values for the rebuild.
  $base_key = pds_recipe_slider_banner_base_key($form, $form_state, ['slider_banner_ui', 'panes', 'edit_slide']);
  $slides = $form_state->get('working_slides');
  if (!is_array($slides) && $parent_state) {
    $slides = $parent_state->get('working_slides');
  }

  if (is_array($slides) && isset($slides[$index]) && is_array($slides[$index])) {
    //2.- Extract the stored slide details and normalize them for the form API.
    $slide = $slides[$index];
    $normalized = [
      'slide_desktop_src' => (string) ($slide['desktop_src'] ?? ''),
      'slide_mobile_src' => (string) ($slide['mobile_src'] ?? ''),
      'slide_alt' => (string) ($slide['alt'] ?? ''),
      'slide_title_html' => (string) ($slide['title_html'] ?? ''),
      'slide_intro' => (string) ($slide['intro'] ?? ''),
      'slide_cta_label' => (string) ($slide['cta_label'] ?? ''),
      'slide_cta_url' => (string) ($slide['cta_url'] ?? ''),
      'slide_desktop_upload' => [],
      'slide_mobile_upload' => [],
    ];

    if (isset($slide['desktop_file_fid']) && is_numeric($slide['desktop_file_fid'])) {
      $normalized['slide_desktop_upload'] = [(int) $slide['desktop_file_fid']];
    }
    if (isset($slide['mobile_file_fid']) && is_numeric($slide['mobile_file_fid'])) {
      $normalized['slide_mobile_upload'] = [(int) $slide['mobile_file_fid']];
    }

    //3.- Push the normalized values into both the form state and user input so
    //     Drupal prefers them over the empty submission payload we just sent.
    foreach ($normalized as $key => $value) {
      $full_key = array_merge($base_key, [$key]);
      $form_state->setValue($full_key, $value);
    }
    $user_input = $form_state->getUserInput();
    if (!is_array($user_input)) {
      $user_input = [];
    }
    foreach ($normalized as $key => $value) {
      NestedArray::setValue($user_input, array_merge($base_key, [$key]), $value);
    }
    $form_state->setUserInput($user_input);

    if ($parent_state) {
      foreach ($normalized as $key => $value) {
        $parent_state->setValue(array_merge($base_key, [$key]), $value);
      }
      $parent_input = $parent_state->getUserInput();
      if (!is_array($parent_input)) {
        $parent_input = [];
      }
      foreach ($normalized as $key => $value) {
        NestedArray::setValue($parent_input, array_merge($base_key, [$key]), $value);
      }
      $parent_state->setUserInput($parent_input);
    }
  }

  $form_state->setRebuild(TRUE);
  pds_recipe_slider_banner_set_active_tab($form_state, 'edit');
}

/**
 * Validate updated slide information.
 */
function pds_recipe_slider_banner_edit_slide_validate(array &$form, FormStateInterface $form_state): void {
  $base_key = pds_recipe_slider_banner_base_key($form, $form_state, ['slider_banner_ui', 'panes', 'edit_slide']);
  $parent_state = pds_recipe_slider_banner_parent_state($form_state);

  $desktop_src = trim((string) $form_state->getValue(array_merge($base_key, ['slide_desktop_src'])));
  $desktop_upload = $form_state->getValue(array_merge($base_key, ['slide_desktop_upload']));
  $desktop_upload_info = pds_recipe_slider_banner_extract_uploaded_image($desktop_upload);
  $mobile_src = trim((string) $form_state->getValue(array_merge($base_key, ['slide_mobile_src'])));
  $mobile_upload = $form_state->getValue(array_merge($base_key, ['slide_mobile_upload']));
  $mobile_upload_info = pds_recipe_slider_banner_extract_uploaded_image($mobile_upload);
  $alt = trim((string) $form_state->getValue(array_merge($base_key, ['slide_alt'])));
  $title_html = trim((string) $form_state->getValue(array_merge($base_key, ['slide_title_html'])));
  $intro = trim((string) $form_state->getValue(array_merge($base_key, ['slide_intro'])));
  $cta_label = trim((string) $form_state->getValue(array_merge($base_key, ['slide_cta_label'])));
  $cta_url = trim((string) $form_state->getValue(array_merge($base_key, ['slide_cta_url'])));

  if ($desktop_upload_info['error'] !== NULL) {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_desktop_upload'])), $desktop_upload_info['error']);
  }
  elseif ($desktop_upload_info['url'] !== NULL) {
    $desktop_src = $desktop_upload_info['url'];
  }

  if ($mobile_upload_info['error'] !== NULL) {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_mobile_upload'])), $mobile_upload_info['error']);
  }
  elseif ($mobile_upload_info['url'] !== NULL) {
    $mobile_src = $mobile_upload_info['url'];
  }

  if ($desktop_src === '') {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_desktop_src'])), t('Desktop image URL is required.'));
  }
  if ($mobile_src === '') {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_mobile_src'])), t('Mobile image URL is required.'));
  }
  if ($alt === '') {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_alt'])), t('Alternative text is required.'));
  }
  if ($title_html === '') {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_title_html'])), t('Title is required.'));
  }
  if ($cta_label === '') {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_cta_label'])), t('CTA label is required.'));
  }
  if ($cta_url === '') {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_cta_url'])), t('CTA URL is required.'));
  }

  if ($desktop_src !== '' && !pds_recipe_slider_banner_is_allowed_url($desktop_src)) {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_desktop_src'])), t('Desktop image URL must be absolute or start with / or a stream wrapper.'));
  }
  if ($mobile_src !== '' && !pds_recipe_slider_banner_is_allowed_url($mobile_src)) {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_mobile_src'])), t('Mobile image URL must be absolute or start with / or a stream wrapper.'));
  }
  if ($cta_url !== '' && !pds_recipe_slider_banner_is_allowed_url($cta_url)) {
    $form_state->setErrorByName(implode('][', array_merge($base_key, ['slide_cta_url'])), t('CTA URL must be absolute or start with /.'));
  }

  if ($form_state->hasAnyErrors()) {
    $form_state->set('pds_recipe_slider_banner_edit_slide_payload', NULL);
    if ($parent_state) {
      $parent_state->set('pds_recipe_slider_banner_edit_slide_payload', NULL);
    }
    return;
  }

  $payload = [
    'desktop_src' => $desktop_src,
    'mobile_src' => $mobile_src,
    'alt' => $alt,
    'title_html' => $title_html,
    'intro' => $intro,
    'cta_label' => $cta_label,
    'cta_url' => $cta_url,
  ];

  if ($desktop_upload_info['fid'] !== NULL) {
    $payload['desktop_file_fid'] = $desktop_upload_info['fid'];
  }
  if ($mobile_upload_info['fid'] !== NULL) {
    $payload['mobile_file_fid'] = $mobile_upload_info['fid'];
  }

  $form_state->set('pds_recipe_slider_banner_edit_slide_payload', $payload);
  if ($parent_state) {
    $parent_state->set('pds_recipe_slider_banner_edit_slide_payload', $payload);
  }
}

/**
 * Save the edited slide back into the working list.
 */
function pds_recipe_slider_banner_edit_slide_submit(array &$form, FormStateInterface $form_state): void {
  $parent_state = pds_recipe_slider_banner_parent_state($form_state);
  $updated_slide = $form_state->get('pds_recipe_slider_banner_edit_slide_payload');
  if (!is_array($updated_slide)) {
    return;
  }

  pds_recipe_slider_banner_finalize_slide_payload($updated_slide);

  $index = $form_state->get('pds_recipe_slider_banner_editing_index');
  if ($index === NULL && $parent_state) {
    $index = $parent_state->get('pds_recipe_slider_banner_editing_index');
  }
  if (!is_numeric($index)) {
    return;
  }
  $index = (int) $index;

  $slides = $form_state->get('working_slides');
  if (!is_array($slides)) {
    $slides = [];
  }

  if (!isset($slides[$index])) {
    return;
  }

  $slides[$index] = $updated_slide;
  $normalized_slides = array_values($slides);

  $form_state->set('working_slides', $normalized_slides);
  $form_state->set('pds_recipe_slider_banner_editing_index', NULL);
  $form_state->set('pds_recipe_slider_banner_edit_slide_payload', NULL);

  if ($parent_state) {
    $parent_state->set('working_slides', $normalized_slides);
    $parent_state->set('pds_recipe_slider_banner_editing_index', NULL);
    $parent_state->set('pds_recipe_slider_banner_edit_slide_payload', NULL);
  }

  $form_state->setRebuild(TRUE);
  pds_recipe_slider_banner_set_active_tab($form_state, 'slides');
}

/**
 * Cancel edit mode and go back to the list tab.
 */
function pds_recipe_slider_banner_edit_slide_cancel_submit(array &$form, FormStateInterface $form_state): void {
  $parent_state = pds_recipe_slider_banner_parent_state($form_state);
  $form_state->set('pds_recipe_slider_banner_editing_index', NULL);
  $form_state->set('pds_recipe_slider_banner_edit_slide_payload', NULL);
  if ($parent_state) {
    $parent_state->set('pds_recipe_slider_banner_editing_index', NULL);
    $parent_state->set('pds_recipe_slider_banner_edit_slide_payload', NULL);
  }
  $form_state->setRebuild(TRUE);
  pds_recipe_slider_banner_set_active_tab($form_state, 'slides');
}

/**
 * Helper: determine the base form key for nested structures.
 */
function pds_recipe_slider_banner_base_key(array &$form, FormStateInterface $form_state, array $segments): array {
  $trigger = $form_state->getTriggeringElement();
  $parents = is_array($trigger['#parents'] ?? NULL) ? $trigger['#parents'] : [];
  if (in_array('settings', $parents, TRUE) || isset($form['settings'])) {
    array_unshift($segments, 'settings');
  }
  return $segments;
}

/**
 * Helper: locate the parent form state when inside a SubformState.
 */
function pds_recipe_slider_banner_parent_state(FormStateInterface $form_state): ?FormStateInterface {
  if ($form_state instanceof SubformStateInterface && method_exists($form_state, 'getCompleteFormState')) {
    $parent = $form_state->getCompleteFormState();
    if ($parent instanceof FormStateInterface) {
      return $parent;
    }
  }
  return NULL;
}

/**
 * Helper: determine if an URL is safe for configuration.
 */
function pds_recipe_slider_banner_is_allowed_url(string $url): bool {
  if ($url === '') {
    return TRUE;
  }
  if (UrlHelper::isValid($url, TRUE) || UrlHelper::isValid($url, FALSE)) {
    return TRUE;
  }
  return strpos($url, '/') === 0;
}

/**
 * Extract the managed file selection from an image upload widget.
 */
function pds_recipe_slider_banner_extract_uploaded_image($value): array {
  //1.- Provide a predictable response structure for callers.
  $result = [
    'url' => NULL,
    'fid' => NULL,
    'error' => NULL,
  ];

  //2.- Normalize managed_file values into a single numeric fid.
  if (!is_array($value)) {
    return $result;
  }
  $candidates = array_filter($value, static function ($candidate): bool {
    return is_numeric($candidate) && (int) $candidate > 0;
  });
  if ($candidates === []) {
    return $result;
  }
  $fid = (int) reset($candidates);
  if ($fid <= 0) {
    return $result;
  }

  //3.- Load the file and derive the public URL used by the rendered card.
  $file = File::load($fid);
  if (!$file) {
    $result['error'] = t('Unable to load the uploaded image.');
    return $result;
  }
  $url = pds_recipe_slider_banner_build_file_url($file);
  if ($url === NULL) {
    $result['error'] = t('Unable to generate a URL for the uploaded image.');
    return $result;
  }

  $result['fid'] = $fid;
  $result['url'] = $url;
  return $result;
}

/**
 * Build a relative URL for a managed file.
 */
function pds_recipe_slider_banner_build_file_url(File $file): ?string {
  //1.- Convert the stream wrapper URI into an absolute URL.
  $generator = \Drupal::service('file_url_generator');
  $absolute = $generator->generateAbsoluteString($file->getFileUri());
  if (!is_string($absolute) || $absolute === '') {
    return NULL;
  }

  //2.- Normalize to a relative path so configuration stays environment agnostic.
  $relative = NULL;
  if (method_exists($generator, 'transformRelative')) {
    $relative = $generator->transformRelative($absolute);
  }
  if (!is_string($relative) || $relative === '') {
    $relative = pds_recipe_slider_banner_transform_relative_fallback($absolute);
  }
  if (!is_string($relative) || $relative === '') {
    return NULL;
  }

  return $relative;
}


/**
 * Convert an absolute URL into a site-relative path when core helper is absent.
 */
function pds_recipe_slider_banner_transform_relative_fallback(string $absolute): ?string {
  //1.- Abort when the provided value is not an absolute URL.
  if (!UrlHelper::isValid($absolute, TRUE)) {
    return NULL;
  }

  //2.- Extract path, query, and fragment components.
  $parts = parse_url($absolute);
  if ($parts === FALSE) {
    return NULL;
  }
  $relative = $parts['path'] ?? '';
  if (isset($parts['query']) && $parts['query'] !== '') {
    $relative .= '?' . $parts['query'];
  }
  if (isset($parts['fragment']) && $parts['fragment'] !== '') {
    $relative .= '#' . $parts['fragment'];
  }
  if ($relative === '') {
    return NULL;
  }

  //3.- Remove the application's base path when available.
  if (\Drupal::hasService('request_stack')) {
    $request = \Drupal::service('request_stack')->getCurrentRequest();
    if ($request) {
      $base_path = $request->getBasePath();
      if ($base_path !== '' && strpos($relative, $base_path) === 0) {
        $relative = substr($relative, strlen($base_path));
        if ($relative === '') {
          $relative = '/';
        }
        elseif ($relative[0] !== '/') {
          $relative = '/' . $relative;
        }
      }
    }
  }

  return $relative;
}

/**
 * Mark uploaded files as permanent once the slide payload is stored.
 */
function pds_recipe_slider_banner_finalize_slide_payload(array &$slide): void {
  foreach (['desktop', 'mobile'] as $variant) {
    $key = $variant . '_file_fid';
    if (!isset($slide[$key])) {
      continue;
    }

    //1.- Capture and immediately unset the helper key so the snapshot mirrors production data.
    $fid = (int) $slide[$key];
    unset($slide[$key]);
    if ($fid <= 0) {
      continue;
    }

    //2.- Promote the temporary file to permanent storage.
    $file = File::load($fid);
    if (!$file) {
      continue;
    }
    if ($file->isTemporary()) {
      $file->setPermanent();
      $file->save();
    }

    //3.- Register usage so Drupal keeps the asset available for the block configuration.
    if (\Drupal::hasService('file.usage')) {
      $usage = \Drupal::service('file.usage');
      if ($usage instanceof FileUsageInterface) {
        $usage->add($file, 'pds_recipe_slider_banner', 'pds_slider_banner_image', $file->id());
      }
    }
  }
}
