<?php

/**
 * @file
 * Hooks for pds_recipe_template.
 */
use Drupal\Core\Session\AccountInterface;

if (!function_exists('pds_recipe_template_user_can_manage_template')) {
  /**
   * Gate for template admin actions (create/update/list/ensure-group).
   *
   * Keep permissive to match LB editors; tighten later with a custom permission.
   */
  function pds_recipe_template_user_can_manage_template(?AccountInterface $account = NULL): bool {
    $account = $account ?: \Drupal::currentUser();
    if (!$account) {
      return FALSE;
    }

    // Mirror typical LB/blocks editor capabilities.
    $perms = [
      'administer blocks',
      'administer layout builder',
      'configure any layout',
      'configure own layout',
      'configure all layout overrides',
      'configure editable layout overrides',
    ];
    foreach ($perms as $perm) {
      if ($account->hasPermission($perm)) {
        return TRUE;
      }
    }
    return FALSE;
  }
}
/**
 * Implements hook_theme().
 */
function pds_recipe_template_theme($existing, $type, $theme, $path) {
  return [
    'pds_template_block' => [
      'template' => 'pds-template', // templates/pds-template-block.html.twig
      'path' => $path . '/templates',
      'variables' => [
        'items' => [],
        'group_id' => NULL,
        'instance_uuid' => '',
      ],
    ],
  ];
}

/**
 * Legacy shim used by older code paths. Delegates to the GroupEnsurer service.
 *
 * @param string $uuid
 * @param string $type
 *   Recipe type (e.g. 'pds_recipe_template', 'pds_recipe_executives', etc.).
 *
 * @return int
 *   Numeric group id, or 0 on failure.
 */
function pds_recipe_template_ensure_group_and_get_id(string $uuid, string $type = 'pds_recipe_template'): int {
  /** @var \Drupal\pds_recipe_template\Service\GroupEnsurer $ensurer */
  $ensurer = \Drupal::service('pds_recipe_template.template_group_manager');
  return (int) $ensurer->ensureGroupAndGetId($uuid, $type);
}
